define(["timeline","view/base"],function(e,t){var a=t.extend({events:{"shown .accordion-body":"publishTimelineHeight","hidden .accordion-body":"publishTimelineHeight"},subscriptions:{"view:dashboard:complete":"render"},initialize:function(e){_.bindAll(this),this.templar=e.templar,this.dashboardId=e.dashboardId,this.status=e.status,this.popovers=[],this.openPopovers=[],this.alertData=[]},render:function(){this.templar.render({path:"alerttimeline",el:this.$el,data:{}}),this.$timeline=this.$el.find(".alert-timeline .accordion-inner"),this.$accordion=this.$el.find(".alert-timeline .accordion-body")},addPopover:function(){var e=this;jobAlertIdList=_.uniq(e.jobAlertList);for(var t=jobAlertIdList.length-1;t>=0;t--){var a=function(t){{var a=$("<div class='timeline-monitor'>"),o=$("<button/>",{text:"Troubleshoot Monitor","class":"btn"}),i=$(".timeline-group-"+t);i.popover({trigger:"manual",html:!0,placement:"bottom",delay:{show:100,hide:200},container:"body",content:a}).click(function(i){i.stopPropagation();var n=$(this);_.each(e.openPopovers,function(e){e.data("popover").tip().removeClass("active"),e.data("popover").hide()}),e.openPopovers=[],n.toggleClass("active").hasClass("active")?(o.off("click"),$("body").off("click"),n.popover("show"),e.showOverlay(a.parent(),"Loading...","alert-data-overlay"),e.loadAlertIncidentData(t,n,a,function(a){var i=e.createMetaTable(a);n.data("popover").tip().find(".alert-meta-data").length>0?n.data("popover").tip().find(".alert-meta-data").replaceWith(i):n.data("popover").tip().append(i),n.data("popover").tip().append(o),o.on("click",function(a){a.stopPropagation(),n.popover("hide"),n.toggleClass("active"),o.off("click"),e.openPopovers=[],Backbone.Mediator.pub("view:alerttimeline:troubleshoot",t)}),e.openPopovers.push(n),$("body").on("click",function(){e.openPopovers=[],n.removeClass("active"),n.popover("hide")})})):(e.openPopovers=[],n.popover("hide"))})}};a(jobAlertIdList[t])}},loadAlertIncidentData:function(e,t,a,o){var i=this,n=i.collection.get(e),r=/timeline-event-(\d+)/g,s=parseInt(r.exec(t.attr("class"))[1]),d=_.findWhere(i.alertData,{id:s}),l=n.get("name"),c=new XDate(d.start),p=new XDate(d.end),h=n.toJSON(),v=c.diffMinutes(p),u=c.diffHours(p);h.toDate=p.toString("MM/dd/yyyy HH:mm"),h.minutes=500>v?v:500;var m=i.initGraph(a[0]);$.ajax({url:"/monitor.json",type:"post",data:n.toJSON(),async:!1,success:function(e){if("success"==e.status){var t=i.formatGraphData(e.graph_data);i.renderGraphData(m,t),"function"==typeof o&&o({name:l,start:c.toString("MM/dd/yyyy HH:mm"),end:p.toString("MM/dd/yyyy HH:mm"),hrs:Math.floor(u),min:Math.floor(v%60)}),i.hideOverlay(a.parent())}}})},createMetaTable:function(e){return $("<table class='alert-meta-data'><tr><th>Name</th><td>"+e.name+"</td></tr><tr><th>Start</th><td>"+e.start+"</td></tr><tr><th>End</th><td>"+e.end+"</td></tr><tr><th>Duration</th><td>"+e.hrs+" hr "+e.min+" min</td></tr></table>")},publishTimelineHeight:function(){var e=this;Backbone.Mediator.pub("view:alerttimeline:toggle",e.$accordion.height()),$(document.body).css("overflow","auto")},setAlertStatus:function(){var e=this;this.status&&e.$el.find(".icon-bell-alt").addClass("alert-status")},setupAlertTimeline:function(){var t=this,a=[];$.ajax("/dashboards/"+t.dashboardId+"/errors",{success:function(o){_.each(o,function(e){var o=null;_.extend(e,{name:"undefined"!=typeof t.collection.get(e.jobId)?t.collection.get(e.jobId).get("name"):""}),o=t.formatServerDateTime(e.date,!0)<new XDate(Date.now(),!0).addWeeks(-2)?new XDate(Date.now(),!0).addWeeks(-2):t.formatServerDateTime(e.date,!0),t.alertData.push({id:e.id,jobId:e.jobId,start:o,end:e.endDate?t.formatServerDateTime(e.endDate,!0):t.formatServerDateTime(Date.now(),!0),status:e.status,content:e.name}),a.push(e.jobId)}),t.timeline=new e(t.$timeline[0]);var i=new XDate(Date.now()-864e5,!0),n=new XDate(Date.now()+432e5,!0);t.timeline.draw(t.alertData,{utc:!0,start:i,end:n,width:"100%",editable:!1,style:"box",intervalMin:6e5,intervalMax:2592e5}),t.$timeline.on("mouseenter",function(){$(window).on("scroll",t.stopBrowserScroll)}),t.$timeline.on("mouseleave",function(){$(window).off("scroll",t.stopBrowserScroll)}),t.jobAlertList=a,t.addPopover()}})},stopBrowserScroll:function(){window.scrollTo(0,0)},showOverlay:function(e,t,a){var o=this;if(e=$(e),!o.overlay){var a=a?a:"";e.data("overlay",$("<div class='overlay "+a+"'><h1></h1></div>")),e.append(e.data("overlay"))}e.data("overlay").find("h1").html(t),e.data("overlay").show()},hideOverlay:function(e){e.data("overlay").hide()},destructor:function(){var e=this,t=e.$el.prev();e.destroySubscriptions(),e.remove(),e.unbind(),e.off(),e.$el.empty(),$("<section class='timeline-wrap clearfix'></section>").insertAfter(t)}});return a});