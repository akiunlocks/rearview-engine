define(["view/base","view/deletemonitor","model/monitor","util/cron","parsley"],function(e,t,i,r){var o=e.extend({cronScheduleFormValid:!0,cronScheduleWeekdaysSelected:!1,cronScheduleDaysDisabled:!1,events:{"click .name-save":"updateMonitorName","click .schedule-tab":"_setExpandedViewHeight","click #cronScheduleFormEdit .day-month-picker .day-picker button":"cronWeekdayButtonClicked","change #selectPreviousError":"_setErrorDropDown"},subscriptions:{"view:dashboard:init":"exit","view:deletemonitor:delete":"deleteMonitor"},initialize:function(e){_.bindAll(this);this.user=e.user,this.router=e.router,this.templar=e.templar,this.deleteMonitorView=new t({el:$(".delete-monitor-wrap"),templar:this.templar});var i=_.debounce(this._setExpandedViewHeight,500);$(window).resize(i)},render:function(e,t,i,r){this.monitorId=e,this.categories=t,this.categoryId=i,this.dashboardId=r,this.initMonitor()},initMonitor:function(){var e=this;e.getMonitor(e.monitorId,function(t){e.model=t,_.bind(e.updateMonitor,e,e.model),_.each(e.categories,function(t){t.selected=t.id===e.model.get("dashboardId")?!0:!1}),e.getGraphData(e.monitorId,function(){e._initErrorsList(function(t){e.templar.render({path:"expandedmonitor",el:e.$el,data:{monitor:e.model.toJSON(),errors:t,alerts:t,output:e.model.get("output"),categories:e.categories}}),e.$monitor=e.$el.find(".expanded-monitor"),e.$el.html(e.$monitor),e._setAlertsHistory(),e.chart=e.initGraph(e.$monitor.find(".graph")[0]),e._setErrorState(),e.updateGraph(e.model,function(t){e._initializeCodeMirror(),e._initializeDatePicker(".input-from-date"),e._setErrorDropDown(),e._setScheduleData(),e._setEditNameField(),e.$el.find(".save-changes").click({model:e.model},e.updateMonitor),e.$el.find(".cancel-changes").click(function(){e.exit()}),e.$el.find(".test-in-graph button").click({model:new i,output:t},e.testMonitor,e),e.open()},e.formattedGraphData),e.setHelp(),e.setCronScheduleValidation(),e._setExpandedViewHeight()},e.model)})})},setCronScheduleWeekdaysSelected:function(){this.cronScheduleWeekdaysSelected=$("#cronScheduleFormEdit .day-month-picker .day-picker button.active").size()>0},setCronScheduleDaysDisabled:function(e){e?this.cronScheduleDaysDisabled||($("#inputDays").parsley("ParsleyField").reset(),$("#inputDays").val("?"),$("#inputDays").attr("disabled",""),this.cronScheduleDaysDisabled=!0):this.cronScheduleDaysDisabled&&($("#inputDays").val("*"),$("#inputDays").removeAttr("disabled"),this.cronScheduleDaysDisabled=!1)},cronWeekdayButtonClicked:function(e){$(e.target).button("toggle"),this.setCronScheduleWeekdaysSelected(),this.setCronScheduleDaysDisabled(this.cronScheduleWeekdaysSelected)},setCronScheduleValidation:function(){this.cronScheduleForm=$("#cronScheduleFormEdit");var e=r.parsleyValidator();_.extend(e,{errors:{container:function(e,t){var i=$("#cronScheduleFormEditErrors");return i.append(t),i}},listeners:{onFormSubmit:function(e){this.cronScheduleFormValid=e}.bind(this)}}),this.cronScheduleForm.parsley(e)},getGraphData:function(e,t){var i=this;$.ajax({url:"/jobs/"+e+"/data",success:function(e){e.graph_data&&(i.formattedGraphData=i.formatGraphData(e.graph_data)),_.isUndefined(t)||t(e)},error:function(e){_.isUndefined(t)||t(e)}})},getMonitor:function(e,t){var r=this;r.model=new i({id:e}),r.model.fetch({success:function(e){_.isUndefined(t)||t(e)}})},getErrorStatus:function(e){var t=!1;switch(e){case"error":t=!0;break;case"failed":t=!0;break;case"graphite_error":t=!0;break;case"graphite_metric_error":t=!0;break;case"security_error":t=!0}return t},setHelp:function(){var e=this,t="";$alertContent="",$cronHelpContent="",$.ajax({url:rearview.path+"/help/cron.html",async:!1,success:function(e){$cronHelpContent=e}}),$.ajax({url:rearview.path+"/help/quick.html",async:!1,success:function(e){t=e}}),$.ajax({url:rearview.path+"/help/alert.html",async:!1,success:function(e){$alertContent=e}}),e.$el.find("#viewSchedule .help.label").tooltip({trigger:"click",html:!0,placement:"left",delay:{show:100,hide:200},title:$cronHelpContent}),e.$el.find(".help:nth-child(2)").tooltip({trigger:"click",html:!0,placement:"right",delay:{show:100,hide:200},title:t}),e.$el.find("#viewSettings .monitor-meta .pager-duty .help.label").tooltip({trigger:"click",html:!0,placement:"left",delay:{show:100,hide:200},title:$alertContent})},open:function(){this.$el.addClass("active"),Backbone.Mediator.pub("view:expandedmonitor:open",{nav:{back:!0}}),this.router.navigate("dash/"+this.dashboardId+"/expand/"+this.model.get("id"))},exit:function(e){var t=this;t.$el.removeClass("active"),t.model&&t.router.navigate("dash/"+t.model.get("dashboardId")),Backbone.Mediator.pub("view:expandedmonitor:exit",{status:"delete"})},updateGraph:function(e,t,i){var r=this;i?(r.renderGraphData(r.chart,i),"function"==typeof t&&t()):$.ajax({url:"/monitor.json",type:"POST",data:e.toJSON(),success:function(e){if(e.graph_data){var i=r.formatGraphData(e.graph_data);r.renderGraphData(r.chart,i),r.$el.find("textarea.output-view").val(e.output)}"error"===e.status&&Backbone.Mediator.pub("view:expandedmonitor:test",{model:this.model,errors:e.errors,raw:e.output,attention:"Monitor Test Error!",status:"error"}),"function"==typeof t&&t(e.output)},failure:function(){}})},testMonitor:function(e){var t=this,i=e.data.model,r=e.data.output,o=$(e.target);o.button("loading"),i=t._setMetrics(i),i=t._setSchedule(i),t.$el.find("textarea.output-view").val(r),t.$el.find(".output-tab").tab("show"),t.updateGraph(i,function(){o.button("reset")})},viewErrorInGraph:function(e){var t=this,i=e.data.model,r=e.data.output,o=e.data.toDate;i.set("toDate",o),i=t._setMetrics(i,!0),i=t._setSchedule(i),t.$el.find("textarea.output-view").val(r),t.$el.find(".output-tab").tab("show"),t.updateGraph(i)},updateMonitor:function(e){{var t=this,i=e.data.model;e.data.test,e.data.toDate,e.data.output}this.cronScheduleForm.parsley("validate"),this.cronScheduleFormValid&&(i=t._setMetrics(i),i=t._setSchedule(i),i=t._setSettings(i),i.save(null,{success:function(e){Backbone.Mediator.pub("view:expandedmonitor:save",{model:t.model,message:"The monitor '"+e.get("name")+"' was saved.",attention:"Monitor Saved!",status:"success"}),t.exit(i),t.updateGraph(i)},error:function(e,i){Backbone.Mediator.pub("view:expandedmonitor:save",{model:t.model,tryJSON:i.responseText,attention:"Monitor Saved Error!",status:"error"})}}))},deleteMonitor:function(){var e=this;e.model.destroy({success:function(t){Backbone.Mediator.pub("view:expandedmonitor:delete",{model:e.model,message:"The monitor '"+t.get("name")+"' was removed from the current dashboard.",attention:"Monitor Deleted!"})},error:function(t){Backbone.Mediator.pub("view:expandedmonitor:delete",{model:e.model,message:"The monitor '"+t.get("name")+"' produced an error during the process of deletion.",attention:"Monitor Delete Error!",status:"error"})}}),e.exit()},updateMonitorName:function(){{var e=this,t=e.$el.find(".name-field");t.prev().html()}e.model.set({name:t.find("input").val()}),t.prev().html(e.model.get("name")),t.hide(),t.prev().show()},resize:function(){var e=this;return _.debounce(e._setExpandedViewHeight,500)},destructor:function(){var e=this,t=e.$el.prev();e.deleteMonitorView.destructor(),e.destroySubscriptions(),e.remove(),e.unbind(),e.off(),t.after("<div class='edit-monitor-wrap clearfix'>")},_setExpandedViewHeight:function(){var e=580,t=6,i=4,r=this.$el.find("#viewMetrics")?this.$el.find("#viewMetrics").height():null;r&&this.$el.find("#viewSchedule, #viewSettings").css({height:r+"px"}),this.$el.find(".output-view").css({height:$(window).height()-e-i+"px"}),this.$el.find(".alerts-history ul").css({height:$(window).height()-e-t+"px"}),this.$el.find(".graph").css({height:$(window).height()-e+"px"});var o=$(window).height()-e>150?$(window).height()-e:150;this.chart&&o>150&&this.chart.setSize(null,o)},_setErrorState:function(){var e=this.getErrorStatus(this.model.get("status"));e?this.$monitor.addClass("red"):this.$monitor.removeClass("red")},_initErrorsList:function(e){var t=this,i=t.model.get("id");$.get("/jobs/"+i+"/errors",function(i){i=_.map(i,function(e){return{label:t.formatServerDateTime(e.date,!0).toString("MM/dd/yyyy HH:mm"),value:e.date,message:e.message,id:e.id}}),e(i)})},_setErrorDropDown:function(){var e=this,t=this.$el.find("#selectPreviousError");if(""!==t.find("option:selected").val()){var i=t.find("option:selected").html();e.fromDatePicker.datetimepicker("setDate",i)}},_setEditNameField:function(){var e=this,t=e.$el.find(".name-field");t.prev().click(function(){t.prev().hide(),t.show(),t.find("input").focus()})},_initializeCodeMirror:function(){var e=this,t=e.$el.find("#inputExpressions")[0],i=e.$el.find("#inputMetrics")[0];e.expressionsMirror=CodeMirror.fromTextArea(t,{value:"",lineNumbers:!0,lineWrapping:!0,height:"100",mode:"ruby",theme:"ambiance",onKeyEvent:function(t,i){return 70==i.keyCode&&i.ctrlKey&&"keydown"==i.type?(i.stop(),e._toggleFullscreen(".expanded-monitor .expressions .CodeMirror",e.expressionsMirror)):void 0}}),e.metricsMirror=CodeMirror.fromTextArea(i,{value:"",lineNumbers:!0,lineWrapping:!0,mode:"ruby",theme:"ambiance",onKeyEvent:function(t,i){return 70==i.keyCode&&i.ctrlKey&&"keydown"==i.type?(i.stop(),e._toggleFullscreen(".expanded-monitor .metrics .CodeMirror",e.metricsMirror)):void 0}})},_initializeDatePicker:function(e){var t=this;t.fromDatePicker=t.$el.find(e).datetimepicker()},_setScheduleData:function(){var e=this,t=e.model.get("cronExpr").split(" ");e.$el.find("#inputSeconds").val(t[0]),e.$el.find("#inputMinutes").val(t[1]),e.$el.find("#inputHours").val(t[2]),e.$el.find("#inputDays").val(t[3]);var i=t[4].split(","),r=t[5].split(",");e._setButtonGroup(e.$el.find(".day-picker button"),r),e._setButtonGroup(e.$el.find(".month-picker button"),i)},_setButtonGroup:function(e,t){e.each(function(e,i){i=$(i);var r=_.indexOf(t,i.attr("data-value"));r>-1&&i.addClass("active")})},_setMetrics:function(e,t){var i=this;return e.set({userId:i.user.get("id"),monitorExpr:i.expressionsMirror.getValue(),metrics:i.metricsMirror.getValue().split("\n"),minutes:parseInt(i.$el.find(".input-minutes-back").val()),toDate:t?e.get("toDate"):i.$el.find(".input-from-date").val()}),e},_setSchedule:function(e){var t=this.$el.find(".monitor-name")[0]?this.$el.find(".monitor-name").val():e.get("name");return e.set({userId:this.user.get("id"),name:t,description:this.$el.find("#description").val(),alertKeys:this.parseAlertKeys(this.$el.find(".pager-duty textarea").val()),cronExpr:this._createCronExpr()}),e},_setSettings:function(e){return e.set({dashboardId:parseInt(this.$el.find("#selectCategory").val(),10)}),e},_setAlertsHistory:function(){var e=this;e.$monitor.find(".alerts-history ul").delegate("li button","click",function(t){e.viewErrorInGraph({data:{model:new i,test:!0,toDate:$(t.target).attr("data-date")}}),e.fromDatePicker.datetimepicker("setDate",$(t.target).attr("data-date"))})}});return o});